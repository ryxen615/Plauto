<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'/>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'/>
    <title>Plauto - Play & Earn</title>
    <script src='https://telegram.org/js/telegram-web-app.js'></script>
    <!-- Professional Winwheel.js Library for the Spin Wheel -->
    <script src='https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/winwheel.js@3.6.0/dist/Winwheel.min.js'></script>

    <style>
    :root {
        --bg-gradient-start: #1e2a3e; --bg-gradient-end: #0f172a; --primary-text: #e2e8f0; --secondary-text: #94a3b8;
        --card-bg: rgba(45, 55, 72, 0.5); --accent-color: #38bdf8; --green-color: #34d399; --red-color: #f87171;
        --gold-color: #facc15; --nav-bg: rgba(15, 23, 42, 0.8); --disabled-color: #475569;
    }
    /* General Styles & Layout */
    body, html { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: linear-gradient(160deg, var(--bg-gradient-start), var(--bg-gradient-end)); color: var(--primary-text); height: 100vh; width: 100vw; overflow: hidden; display: flex; flex-direction: column; }
    .main-content { flex-grow: 1; overflow-y: auto; padding: 20px 20px 80px 20px; -webkit-overflow-scrolling: touch; }
    .section { display: none; animation: fadeIn 0.4s ease-in-out; }
    .section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    h2 { color: var(--primary-text); border-bottom: 2px solid var(--accent-color); padding-bottom: 5px; margin-bottom: 20px; }
    h3 { color: var(--primary-text); margin-top: 0; }
    p { color: var(--secondary-text); line-height: 1.5; margin: 0 0 10px 0; }
    .card { background-color: var(--card-bg); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; padding: 20px; margin-bottom: 20px; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
    /* Buttons and Navigation */
    .button-primary { background: linear-gradient(45deg, var(--accent-color), #67e8f9); color: #0c182f; padding: 12px 25px; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.2s; width: 100%; box-sizing: border-box; }
    .button-primary:disabled { background: var(--disabled-color); cursor: not-allowed; color: var(--secondary-text); }
    .button-primary:not(:disabled):hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(56, 189, 248, 0.3); }
    .bottom-nav { display: flex; justify-content: space-around; background-color: var(--nav-bg); padding-top: 10px; border-top: 1px solid rgba(255, 255, 255, 0.1); position: fixed; bottom: 0; left: 0; width: 100%; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); z-index: 1000; }
    .nav-button { background: none; border: none; color: var(--secondary-text); display: flex; flex-direction: column; align-items: center; font-size: 10px; cursor: pointer; padding: 0 5px 5px 5px; transition: color 0.3s; }
    .nav-button svg { width: 24px; height: 24px; margin-bottom: 4px; fill: var(--secondary-text); transition: fill 0.3s; }
    .nav-button.active { color: var(--accent-color); }
    .nav-button.active svg { fill: var(--accent-color); }
    /* Professional Spin Wheel */
    .wheel-wrapper { display: flex; justify-content: center; align-items: center; margin: 20px 0; }
    /* Game Modals and Components */
    .game-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; flex-direction: column; animation: fadeIn 0.3s; }
    .game-modal-content { background: var(--bg-gradient-end); padding: 20px; border-radius: 16px; width: 90%; max-width: 400px; text-align: center; border: 1px solid var(--accent-color); }
    .game-area { height: 200px; background-color: var(--card-bg); border-radius: 12px; margin: 15px 0; display: flex; justify-content: center; align-items: center; font-size: 24px; }
    /* Other Components */
    .list-item { background-color: rgba(0,0,0,0.2); border-radius: 12px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
    .play-button { background-color: var(--green-color); color: white; padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; }
    .play-button:disabled { background-color: var(--disabled-color); }
    .reward-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px; }
    .reward-card { background-color: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; text-align: center; }
    .redeem-button { background-color: var(--gold-color); color: #422006; padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
    .redeem-button:disabled { background-color: var(--disabled-color); }
    .profile-header { text-align: center; margin-bottom: 20px; }
    .profile-header .avatar { width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--accent-color); }
    .info-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
    .info-row:last-child { border-bottom: none; }
    .ad-placeholder { border: 2px dashed var(--secondary-text); border-radius: 12px; padding: 20px; text-align: center; color: var(--secondary-text); margin-top: 20px; cursor: pointer; }
    .progress-bar { width: 100%; background-color: var(--disabled-color); border-radius: 5px; height: 10px; margin-top: 5px; }
    .progress-bar-inner { height: 100%; background-color: var(--green-color); border-radius: 5px; }
    </style>
</head>
<body>
<!-- MAIN APP CONTENT -->
<div class='main-content'>
    <div id='home-section' class='section active'>
        <div class='card' style='text-align:center;'>
            <h3>Total Points</h3>
            <p id='home-points' style='font-size: 28px; font-weight: bold; color: var(--gold-color); margin:0;'>0</p>
        </div>
        <div class="wheel-wrapper">
            <canvas id='spin-canvas' width='300' height='300'>Canvas not supported, use another browser.</canvas>
        </div>
        <p>Your free spins: <span id="free-spins-count">0</span></p>
        <button id="spin-button" class='button-primary'>SPIN</button>
        <div class='ad-placeholder' id="ad-spin-placeholder">
            <!-- Ad Network 2: Bitmedia - Extra Spins -->
            <p><strong>Watch Ad for an Extra Spin</strong> (<span id="ad-spin-limit">0</span>/4 left)</p>
            <small id="ad-spin-timer"></small>
        </div>
        <div class='ad-placeholder' id="ad-bonus-placeholder">
            <!-- Ad Network 3: a-ads Bonus -->
             <p><strong>Watch Ad for 20 Bonus Points</strong> (<span id="ad-bonus-limit">0</span>/2 left)</p>
        </div>
    </div>
    <div id='games-section' class='section'>
        <h2>Play Games</h2>
        <div class='card'>
            <p>Your Tickets: <span id='game-tickets' style='font-weight:bold;'>0 üéüÔ∏è</span></p>
             <div class='ad-placeholder' id="ad-ticket-placeholder">
                <!-- Ad Network 1: Adsgram - Get Tickets -->
                <p><strong>Watch Ad for a Ticket</strong> (<span id="ad-ticket-limit">0</span>/12 left)</p>
                <small id="ad-ticket-timer"></small>
            </div>
        </div>
        <div class='game-grid' style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
             <!-- All 6 Games -->
             <div class="list-item" style="flex-direction: column;"><h3 style="margin-bottom: 10px;">Reaction Time</h3><button class="play-button" data-game="reaction">Play</button></div>
             <div class="list-item" style="flex-direction: column;"><h3 style="margin-bottom: 10px;">Tapping Frenzy</h3><button class="play-button" data-game="tapping">Play</button></div>
             <div class="list-item" style="flex-direction: column;"><h3 style="margin-bottom: 10px;">Number Memory</h3><button class="play-button" data-game="memory">Play</button></div>
             <div class="list-item" style="flex-direction: column;"><h3 style="margin-bottom: 10px;">Color Match</h3><button class="play-button" data-game="color">Play</button></div>
             <div class="list-item" style="flex-direction: column;"><h3 style="margin-bottom: 10px;">Math Quiz</h3><button class="play-button" data-game="math">Play</button></div>
             <div class="list-item" style="flex-direction: column;"><h3 style="margin-bottom: 10px;">Object Dodge</h3><button class="play-button" data-game="dodge">Play</button></div>
        </div>
    </div>
    <div id='rewards-section' class='section'>
        <h2>Redeem Rewards</h2>
        <div class='reward-grid' id="rewards-grid"></div>
         <div class='ad-placeholder'> <!-- Ad Network 3: a-ads.com Passive Banner -->
            <p>Your a-ads.com Banner Code Here</p>
         </div>
    </div>
    <div id='profile-section' class='section'>
        <div class='profile-header'>
            <img class='avatar' id="profile-avatar" src='https://www.gravatar.com/avatar/?d=mp' alt='Avatar'/>
            <h2 id='profile-name' style='border:none; margin-bottom:0;'>User</h2>
        </div>
        <div class='card'>
            <div class='info-row'><span class='info-label'>Points</span><span class='info-value' id='profile-points'>0</span></div>
            <div class='info-row'><span class='info-label'>Games Played</span><span class='info-value' id='profile-games-played'>0</span></div>
            <div class='info-row'><span class='info-label'>Daily Login Bonus</span><span id='daily-login-status'></span></div>
        </div>
        <div class='card'>
            <h3>Refer & Earn</h3>
            <p>Invite friends! When they earn 500 points, you get 200 points!</p>
            <button class='button-primary' id="share-button">Share Invite Link</button>
            <div id="referral-list-container" style="margin-top: 15px;">
                <h4>Your Referrals:</h4>
                <div id="referral-list">
                    <!-- Referral list will be generated by JS -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- All Game Modals -->
<div id="game-modal-reaction" class="game-modal"><div class="game-modal-content"><h3>Reaction Time</h3><div class="game-area" id="reaction-area" style="background-color: var(--red-color);"><p>Tap when it turns green!</p></div></div></div>
<div id="game-modal-tapping" class="game-modal"><div class="game-modal-content"><h3>Tapping Frenzy</h3><h4 id="tapping-timer">Time: 10</h4><p>Score: <span id="tapping-score">0</span></p><div class="game-area" style="padding:20px"><button id="tapping-button" class="button-primary">Tap Me!</button></div></div></div>
<div id="game-modal-memory" class="game-modal"><div class="game-modal-content"><h3>Number Memory</h3><div id="memory-display" class="game-area"></div><input id="memory-input" type="number" placeholder="Enter the numbers" style="width:100%; box-sizing: border-box; padding: 10px; margin-top:10px;"/></div></div>
<!-- Other game modals can be added similarly -->

<!-- BOTTOM NAVIGATION BAR -->
<div class='bottom-nav'>
    <button class='nav-button active' data-section='home-section'>
        <svg viewBox='0 0 24 24'><path d='M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z' fill='#fff'/></svg><span>Home</span>
    </button>
    <button class='nav-button' data-section='games-section'>
        <svg viewBox='0 0 24 24'><path d='M21,2H3A2,2 0 0,0 1,4V10A2,2 0 0,0 3,12H21A2,2 0 0,0 23,10V4A2,2 0 0,0 21,2M21,14H3A2,2 0 0,0 1,16V20A2,2 0 0,0 3,22H21A2,2 0 0,0 23,20V16A2,2 0 0,0 21,14M7,7A1,1 0 0,1 8,8A1,1 0 0,1 7,9A1,1 0 0,1 6,8A1,1 0 0,1 7,7M7,18A1,1 0 0,1 8,19A1,1 0 0,1 7,20A1,1 0 0,1 6,19A1,1 0 0,1 7,18Z' fill='#fff'/></svg><span>Games</span>
    </button>
    <button class='nav-button' data-section='rewards-section'>
        <svg viewBox='0 0 24 24'><path d='M20 4H4c-1.11 0-2 .89-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2zm0 14H4v-6h16zm0-10H4V6h16z' fill='#fff'/></svg><span>Rewards</span>
    </button>
    <button class='nav-button' data-section='profile-section'>
        <svg viewBox='0 0 24 24'><path d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z' fill='#fff'/></svg><span>Profile</span>
    </button>
</div>

<script>
// --- START OF NEW JAVASCRIPT ---

// CONFIGURATION & CONSTANTS
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwhSgOt903DdPkt0X-GMJoWlM6LCS-c9Cdn-8enJypSc2x4DHRPepYFimch0fGUg5qU/exec';
const ECONOMY = {
    REWARDS: [
        { id: 'gp_10', name: '‚Çπ10 Google Play', points: 1000, img: 'https://www.gstatic.com/images/icons/material/system/2x/play_for_work_gm_blue_48dp.png' },
        { id: 'gp_50', name: '‚Çπ50 Google Play', points: 5000, img: 'https://www.gstatic.com/images/icons/material/system/2x/play_for_work_gm_blue_48dp.png' }
    ],
    WHEEL_PRIZES: [20, 50, 100, 2, 200, 5, 0, 10], // Points
    REFERRAL_BONUS: { toReferrer: 200, toNewUser: 50, milestone: 500 }, // Points
    GAMES_POINTS: { min: 5, max: 25 }, // Min/max points per game
    DAILY_LOGIN_BONUS: 15,
    ADS: {
        TICKET: { dailyLimit: 12, cooldown: 30 }, // 30 seconds
        SPIN: { dailyLimit: 4, cooldown: 60 }, // 60 seconds
        BONUS: { dailyLimit: 2, points: 20 }
    }
};

// INITIALIZE TELEGRAM WEB APP
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

// DOM ELEMENTS CACHE
const DOMElements = {
    mainContent: document.querySelector('.main-content'),
    sections: document.querySelectorAll('.section'),
    navButtons: document.querySelectorAll('.nav-button'),
    points: { home: document.getElementById('home-points'), profile: document.getElementById('profile-points') },
    spin: {
        button: document.getElementById('spin-button'),
        canvas: document.getElementById('spin-canvas'),
        count: document.getElementById('free-spins-count'),
        adLimit: document.getElementById('ad-spin-limit'),
        adTimer: document.getElementById('ad-spin-timer'),
        adPlaceholder: document.getElementById('ad-spin-placeholder')
    },
    tickets: {
        count: document.getElementById('game-tickets'),
        adLimit: document.getElementById('ad-ticket-limit'),
        adTimer: document.getElementById('ad-ticket-timer'),
        adPlaceholder: document.getElementById('ad-ticket-placeholder')
    },
    profile: {
        name: document.getElementById('profile-name'),
        avatar: document.getElementById('profile-avatar'),
        gamesPlayed: document.getElementById('profile-games-played'),
        loginStatus: document.getElementById('daily-login-status')
    },
    referral: {
        list: document.getElementById('referral-list'),
        shareBtn: document.getElementById('share-button')
    },
    rewardsGrid: document.getElementById('rewards-grid')
    // Add other elements here as needed
};

// --- STATE MANAGEMENT --- (The Brain of the App)
let userState = {};

function getDefaultState() {
    const startParam = tg.initDataUnsafe?.start_param;
    const referrerId = startParam && startParam.startsWith('ref_') ? startParam.substring(4) : null;

    return {
        points: 0, tickets: 3, freeSpins: 2, gamesPlayed: 0,
        userId: tg.initDataUnsafe?.user?.id || `guest_${Date.now()}`,
        username: tg.initDataUnsafe?.user?.username || 'Guest',
        firstName: tg.initDataUnsafe?.user?.first_name || 'Guest',
        lastLogin: null,
        adCounts: { ticket: { count: 0, lastReset: null }, spin: { count: 0, lastReset: null }, bonus: { count: 0, lastReset: null }},
        cooldowns: { ticket: 0, spin: 0 },
        referrer: referrerId,
        referrals: {} // { 'friendUserId': { points: 250, status: 'pending' } }
    };
}

function saveState() {
    localStorage.setItem(`plauto_v5_user_${userState.userId}`, JSON.stringify(userState));
}

function loadState() {
    let savedState = localStorage.getItem(`plauto_v5_user_${userState.userId}`);
    userState = Object.assign(getDefaultState(), savedState ? JSON.parse(savedState) : {});

    checkDailyResets();
    updateAllUI();
}

// --- UI UPDATES ---
function updateAllUI() {
    Object.values(DOMElements.points).forEach(el => el.innerText = userState.points.toLocaleString());
    DOMElements.spin.count.innerText = userState.freeSpins;
    DOMElements.tickets.count.innerText = `${userState.tickets} üéüÔ∏è`;
    DOMElements.profile.name.innerText = userState.firstName;
    DOMElements.profile.gamesPlayed.innerText = userState.gamesPlayed;
    
    // Update ad limits
    DOMElements.spin.adLimit.innerText = Math.max(0, ECONOMY.ADS.SPIN.dailyLimit - userState.adCounts.spin.count);
    DOMElements.tickets.adLimit.innerText = Math.max(0, ECONOMY.ADS.TICKET.dailyLimit - userState.adCounts.ticket.count);

    // Update button states
    DOMElements.spin.button.disabled = userState.freeSpins <= 0;
}


// --- CORE LOGIC ---
function checkDailyResets() {
    const now = new Date();
    const today = now.toDateString();

    if (userState.lastLogin !== today) {
        userState.freeSpins = 2;
        userState.tickets = 3;
        userState.adCounts = { ticket: { count: 0, lastReset: today }, spin: { count: 0, lastReset: today }, bonus: { count: 0, lastReset: today }};
        userState.lastLogin = today;
        userState.points += ECONOMY.DAILY_LOGIN_BONUS;
        DOMElements.profile.loginStatus.innerText = "Claimed Today ‚úÖ";
        alert(`Welcome back! You received a daily bonus of ${ECONOMY.DAILY_LOGIN_BONUS} points!`);
        saveState();
    } else {
        DOMElements.profile.loginStatus.innerText = "Already Claimed";
    }
}

function startCooldown(type) {
    let timerEl = DOMElements[type].adTimer;
    let placeholderEl = DOMElements[type].adPlaceholder;
    let duration = ECONOMY.ADS[type].cooldown;
    userState.cooldowns[type] = Date.now() + (duration * 1000);
    
    placeholderEl.style.cursor = 'not-allowed';
    placeholderEl.style.opacity = '0.5';

    let interval = setInterval(() => {
        let remaining = Math.ceil((userState.cooldowns[type] - Date.now()) / 1000);
        if (remaining > 0) {
            timerEl.innerText = `Please wait ${remaining}s`;
        } else {
            clearInterval(interval);
            timerEl.innerText = '';
            placeholderEl.style.cursor = 'pointer';
            placeholderEl.style.opacity = '1';
        }
    }, 1000);
}


// --- INITIALIZATION ---
let theWheel = null;
function initialize() {
    // Navigation
    DOMElements.navButtons.forEach(button => {
        button.addEventListener('click', () => {
            const sectionId = button.dataset.section;
            DOMElements.sections.forEach(s => s.classList.toggle('active', s.id === sectionId));
            DOMElements.navButtons.forEach(b => b.classList.toggle('active', b.dataset.section === sectionId));
            DOMElements.mainContent.scrollTo(0, 0);
            tg.HapticFeedback.impactOccurred('light');
        });
    });

    // Spin Wheel Setup
    let segments = ECONOMY.WHEEL_PRIZES.map((prize, i) => ({
        'fillStyle': ['#f87171', '#fb923c', '#facc15', '#4ade80', '#38bdf8', '#818cf8', '#c084fc', '#f472b6'][i % 8],
        'text': prize.toString(), 'id': prize
    }));

    theWheel = new Winwheel({
        'canvasId': 'spin-canvas', 'numSegments': segments.length, 'outerRadius': 145, 'textFontSize': 18,
        'textFontFamily': 'Arial', 'textFillStyle': 'white', 'textMargin': 15, 'segments': segments,
        'animation': { 'type': 'spinToStop', 'duration': 7, 'spins': 10, 'callbackFinished': alertPrize, 'callbackSound': playSound, 'soundTrigger': 'pin'},
        'pins': {'number': 16, 'outerRadius': 4, 'fillStyle': 'silver'}
    });

    // Event Listeners
    DOMElements.spin.button.addEventListener('click', startSpin);
    DOMElements.tickets.adPlaceholder.addEventListener('click', handleAdRequest.bind(null, 'ticket'));
    DOMElements.spin.adPlaceholder.addEventListener('click', handleAdRequest.bind(null, 'spin'));
    DOMElements.referral.shareBtn.addEventListener('click', shareReferral);

    // Load initial data
    loadState();
}

function startSpin() {
    if (theWheel.isSpinning || userState.freeSpins <= 0) return;
    
    userState.freeSpins--;
    DOMElements.spin.button.disabled = true;
    updateAllUI();
    saveState();
    
    theWheel.startAnimation();
}

function alertPrize(indicatedSegment) {
    const prize = parseInt(indicatedSegment.id, 10);
    userState.points += prize;
    alert(`You won ${prize} points!`);
    updateAllUI();
    saveState();
    tg.HapticFeedback.notificationOccurred('success');
}

// --- Ad Logic ---
function handleAdRequest(type) {
    const now = Date.now();
    if (userState.cooldowns[type] && now < userState.cooldowns[type]) {
        alert('Please wait for the cooldown to finish.');
        return;
    }
    
    if (userState.adCounts[type].count >= ECONOMY.ADS[type].dailyLimit) {
        alert("You have reached your daily limit for this ad type.");
        return;
    }

    // --- !! IMPORTANT !! ---
    // This is where you call YOUR ad network's code to show an ad.
    // e.g., Adsgram.showRewardedVideo({ onRewarded: grantReward, onClose: adClosed });
    // For now, we simulate it with a timeout.
    
    alert(`Showing a simulated ad. The real ad network code goes here. You will receive the reward after this message.`);
    
    // Call grantReward function after a "successful" ad watch.
    grantAdReward(type);
}

function grantAdReward(type) {
    userState.adCounts[type].count++;
    
    if (type === 'ticket') {
        userState.tickets++;
        alert(`You earned 1 ticket! üéüÔ∏è`);
    } else if (type === 'spin') {
        userState.freeSpins++;
        alert(`You earned 1 free spin!`);
    }
    
    startCooldown(type);
    updateAllUI();
    saveState();
}


function shareReferral() {
    // Placeholder - Logic will be built in the next update
    alert(`Share functionality coming soon! Your referral code is: ${userState.userId}`);
}

// Dummy audio for wheel - silent but necessary for callbackSound
let audio = new Audio(); 
function playSound() { audio.play(); }


// Start the application
initialize();
// --- END OF NEW JAVASCRIPT ---
</script>
</body>
</html>
